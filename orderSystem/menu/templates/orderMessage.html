<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>æ¡Œå°ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #f7941e;
            --accent-color: #2ecc71;
            --dark-color: #333;
            --light-color: #f9f9f9;
            --gray-color: #e0e0e0;
        }
        
        body {
            background-color: #fff;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-left: 10px;
        }
        
        .logo-icon {
            font-size: 28px;
            color: var(--primary-color);
        }
        
        .cart-icon {
            position: relative;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-color);
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        
        .header-actions h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-left: 10px;
        }

        /* æ¨ªå¹…æ ·å¼ */
        .banner {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .banner-content h2 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .banner-content p {
            font-size: 18px;
        }
        
        /* èœå•åˆ†ç±» */
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--gray-color);
        }
        
        .category {
            padding: 8px 20px;
            margin-right: 10px;
            background-color: var(--gray-color);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .category.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* èœå•é¡¹ */
        .menu-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            
        }
        
        .menu-item {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
        }
        
        .item-image {
            height: 180px;
            width: 100%;
            background-color: #ddd;
            background-size: cover;
            background-position: center;
        }
        
        .item-content {
            padding: 15px;
        }
        
        .item-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            height: 40px;
            overflow: hidden;
        }
        
        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-price {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .add-to-cart {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .add-to-cart:hover {
            background-color: #e55a2b;
        }
        

        .status {
            margin: 5px 0;
            font-size: 16px;
        }

        .free {
            color: #28a745; /* ç»¿è‰² */
        }

        .busy {
            color: #dc3545; /* çº¢è‰² */
        }

        .order-status {
            color: #007bff;
        }

        #deskItems {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        /* ===== æ¡Œé¢è¡¨æ ¼æ ·å¼ ===== */
        table.minimal {
            width:100%;
            border-collapse:separate; /* ä¿ç•™é—´è·ç”¨äºåœ†è§’ */
            border-spacing:0;
            table-layout:fixed;
            font-size:14px;
        }

        thead th{
            text-align:left;
            font-weight:600;
            padding:14px 16px;
            color:var(--muted);
            font-size:13px;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(0,0,0,0.01), transparent);
        }

        tbody tr{
            transition: transform .12s ease, background .12s ease;
        }

        tbody tr:hover{
            transform: translateY(-3px);
            background: rgba(14,165,164,0.03);
        }

        td{
            padding:14px 16px;
            vertical-align:middle;
            color:var(--accent);
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        /* æ¡çº¹æ•ˆæœ */
        tbody tr:nth-child(odd){
            background: linear-gradient(90deg, rgba(0,0,0,0.00), rgba(0,0,0,0.00));
        }

        /* ç¬¬ä¸€åˆ—ç¨å¾®ç²—ä¸€ç‚¹ */
        tbody td:first-child{
            font-weight:600;
            color:var(--accent);
        }

        /* æ“ä½œæŒ‰é’® */
        .actions button{
            border:0;
            background:transparent;
            padding:6px 10px;
            border-radius:8px;
            cursor:pointer;
            font-size:13px;
        }
        .btn-primary{
            background: linear-gradient(90deg,var(--accent-2), #0284c7);
            color:var(--accent-2);
            box-shadow: 0 4px 10px rgba(14,165,164,0.12);
        }
        .btn-ghost{
            color:var(--accent-2);
            border:1px solid rgba(14,165,164,0.12);
            background:transparent;
        }

        .status-pending {
            background-color: #fcd34d; /* é»„è‰² */
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
        }

        .status-served {
            background-color: #22c55e; /* ç»¿è‰² */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-cooking {
            background-color: #f97316; /* æ©™è‰² */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-cancelled {
            background-color: #9ca3af; /* ç°è‰² */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-finished {
            background-color: #34d399; /* æµ…ç»¿è‰² */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;}

        /* å›¾ç‰‡ç¼©ç•¥ */
        .thumb{
            width:48px;
            height:48px;
            border-radius:8px;
            overflow:hidden;
            display:inline-block;
            vertical-align:middle;
            margin-right:12px;
            border:1px solid var(--line);
        }
        .thumb img{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
        }

        .checkout-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #ff8c00, #ff5500);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            background: linear-gradient(135deg, #ff9e30, #ff6a00);
        }

        .free-btn {
            position: fixed;
            bottom: 30px;
            right: 150px;
            background: linear-gradient(135deg, #ff8c00, #ff5500);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .free-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            background: linear-gradient(135deg, #ff9e30, #ff6a00);
        }

        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 270px;
            background: linear-gradient(135deg, #ff8c00, #ff5500);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            background: linear-gradient(135deg, #ff9e30, #ff6a00);
        }

        .btn {
            display: inline-block;
            font-size: 14px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        /* è“è‰²ä¸»æŒ‰é’® */
        .btn-primary {
            background-color: #1890ff;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
            box-shadow: 0 2px 6px rgba(24, 144, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            background-color: #096dd9;
            box-shadow: none;
            transform: translateY(0);
        }

        .quantity-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .qty-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 26px;
            height: 26px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .qty-btn:hover {
            background-color: #40a9ff;
            transform: translateY(-1px);
        }

        .qty-btn:active {
            background-color: #096dd9;
            transform: translateY(0);
        }

        .qty-value {
            min-width: 24px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }

        .discount-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .dis-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 26px;
            height: 26px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dis-btn:hover {
            background-color: #40a9ff;
            transform: translateY(-1px);
        }

        .dis-btn:active {
            background-color: #096dd9;
            transform: translateY(0);
        }

        .dis-value {
            min-width: 24px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }


        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .banner-content h2 {
                font-size: 28px;
            }
            
            .banner-content p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ½ï¸</span>
                    <h1>æ¡Œå°ç®¡ç†</h1>
                </div>
                <div class="header-actions">
                    <h1 onclick="backManage()">è¿”å›ç®¡ç†ç•Œé¢</h1>
                </div>
            </div>
        </div>
    </header>
 



    <!-- æ¨ªå¹… -->
    <section class="banner">
        <div class="banner-content">
            <h2>{{table_num}}å·æ¡Œ</h2>
        </div>
    </section>

    
        <!-- èœå•é¡¹ -->
        <div class="desk-items" id="deskItems">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

    <div class="table-wrap">
      <div class="card">

        <div style="overflow:auto">
          <table class="minimal" aria-label="è®¢å•è¡¨">
            <thead>
              <tr>
                <th style="width:28%;">èœå“ / æ¡Œå·</th>
                <th style="width:18%;">çŠ¶æ€</th>
                <th style="width:18%;">æ•°é‡</th>
                <th style="width:18%;">å•ä»·</th>
                <th style="width:18%;">æŠ˜æ‰£</th>
                <th style="width:25%;">åˆ›å»ºæ—¶é—´</th>
                <th style="width:18%;">æ€»ä»·</th>
                <th style="width:18%;"></th>
                
              </tr>
            </thead>
            <tbody id = 'order_list'>
              


            </tbody>
          </table>
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="addOrder()">åŠ èœ</button>
    <button class="free-btn" onclick="freeTable()">é‡Šæ”¾</button>
    <button class="checkout-btn" onclick="settleTable()">ç»“ç®—</button>




<script>
    const table_number = {{table_num}};
    const order_tables = document.getElementById('order_list');

    fetch(`/api/get_desk_message_api/${table_number}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(res => res.json())
            .then(data => {
                //alert(data.message);
                console.log('è®¢å•', data);
                //location.reload(); // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
                createOrderList(data);
                
                
            })

    
    function createOrderList(orderData) {
                orderData['orders'].forEach((orderDict,index)=>{
                    console.log(orderDict)
                    orderDict['items'].forEach(item => {
                    const orderItem = document.createElement('tr');
                    const statusClass = getStatusClass(item.status);
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <td id="name-'${item.midOrderId}'">
                            <span class="thumb"><img src="${item.image}" alt="thumb"></span>
                            ${item.name} â€” æ¡Œå· ${item.table_num}
                        </td>
                        <td class="${statusClass}  status-cell" id="status-'${item.midOrderId}'">${item.status}</td> 
                        <td class="quantity-cell">
                            <button class="qty-btn" onclick="changeQuantity('${item.midOrderId}', -1)">âˆ’</button>
                            <span id="qty-'${item.midOrderId}'" class="qty-value">${item.quantity}</span>
                            <button class="qty-btn" onclick="changeQuantity('${item.midOrderId}', 1)">ï¼‹</button>
                        </td>
                        <td id="price-'${item.midOrderId}'">${item.price}</td>
                        <td class="discount-cell">
                            <button class="dis-btn" onclick="changeDiscount('${item.midOrderId}', -0.1)">âˆ’</button>
                            <span id="dis-'${item.midOrderId}'" class="dis-value">${item.discount}</span>
                            <button class="dis-btn" onclick="changeDiscount('${item.midOrderId}', 0.1)">ï¼‹</button>
                        </td>
                        <td>${item.created_at}</td>
                        <td>${(item.quantity*item.price*item.discount).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="orderConfirm('${item.midOrderId}')">æ“ä½œ</button></td>
                        </td>
                    `;
            
            order_tables.appendChild(orderItem);
                                        }
                                )
                                                            }
                                            );
        };

        function orderConfirm(midOrderId) {
            const orderName = String(document.getElementById(`name-'${midOrderId}'`).textContent).trim();
            const qty = parseInt(document.getElementById(`qty-'${midOrderId}'`).textContent);
            const discount = parseFloat(document.getElementById(`dis-'${midOrderId}'`).textContent);
            const price = parseFloat(document.getElementById(`price-'${midOrderId}'`).textContent); // å¦‚æœä½ ç»™ä»·æ ¼åŠ äº†class
            const status = String(document.getElementById(`status-'${midOrderId}'`).textContent).trim();
            // è®¡ç®—æŠ˜åæ€»ä»·ï¼ˆå¯é€‰ï¼‰
            const total = (qty * price * discount).toFixed(2);
            const set_dict = {'table_number': table_number,  'quantity': qty, 'discount': discount, 'status': status};
            
            if (status === 'å·²ä¸‹å•' ){
                if (confirm(`èœå“: ${orderName} \næ•°é‡: ${qty}\næŠ˜æ‰£: ${discount}\næŠ˜åæ€»ä»·: ${total}`)){
                    fetch(`/api/set_midOrder_api/${midOrderId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({ 'data': set_dict })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            alert('æ“ä½œå¤±è´¥ï¼š' + data.error);
                            return;
                        }
                        else{
                        //console.log('è®¢å•åˆ›å»ºæˆåŠŸ:', data);
                            if (data.message === 'success') {
                                alert('æ“ä½œæˆåŠŸ');
                            }
                            window.location.reload(); // åˆ·æ–°é¡µé¢
                        }
                    });
            }
            
            }else{
                alert('å·²ä¸Šèœæˆ–å·²å®Œæˆèœå“ä¸å¯æ“ä½œ');
            };
            
        }

        function changeQuantity(midOrderId, delta) {
            const qtySpan = document.getElementById(`qty-'${midOrderId}'`);
            let current = parseInt(qtySpan.textContent);

            const newQty = Math.max(0, current + delta); // é˜²æ­¢å‡ºç°è´Ÿæ•°
            qtySpan.textContent = newQty;

        }

        function changeDiscount(midOrderId, delta) {
            const disSpan = document.getElementById(`dis-'${midOrderId}'`);
            let current = parseFloat(parseFloat(disSpan.textContent).toFixed(2));

            const newDis = Math.max(0.1, Math.min(1, current + delta)); // é™åˆ¶èŒƒå›´ 0.1~1
            disSpan.textContent = newDis.toFixed(2); // ğŸ‘ˆ æ ¼å¼åŒ–ä¸ºä¸¤ä½å°æ•°
        }

        

        function addOrder(){
            window.location.href = `/orderManageAdd/${table_number}/`;
        };

        function getStatusClass(status) {
            switch (status) {
                case 'å·²ä¸‹å•': return 'status-pending';    // é»„è‰²ï¼šå·²ä¸‹å•
                case 'åˆ¶ä½œä¸­': return 'status-cooking';    // æ©™è‰²ï¼šåˆ¶ä½œä¸­
                case 'å·²ä¸Šèœ': return 'status-served';      // ç»¿è‰²ï¼šå·²ä¸Šèœ
                case 'å·²å–æ¶ˆ': return 'status-cancelled';// ç°è‰²ï¼šå·²å–æ¶ˆ
                case 'å·²å®Œæˆ': return 'status-finished';  // æµ…ç»¿è‰²ï¼šå·²å®Œæˆ
                default: return ''; // å¦‚æœæ²¡æœ‰åŒ¹é…çš„çŠ¶æ€ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªç©ºç±»
            }
        };


    function getCSRFToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    return cookie.substring(name.length + 1);
                }
            }
            return '';
        }

    function freeTable(){
        fetch(`/api/free_table_api/${table_number}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(), 
                        },
                    
                    })
                    .then(res => res.json())
                    .then(data => {
                        //console.log('è®¢å•åˆ›å»ºæˆåŠŸ:', data);
                            if (data.message === 'success') {
                                alert('æ¡Œå­ç©ºé—²');
                                window.location.reload(); // åˆ·æ–°é¡µé¢
                            }else{
                                alert('è¯¥æ¡Œè®¢å•æœªç»“æŸï¼Œæ— æ³•é‡Šæ”¾');
                            }
                            
                        }
                    );
    }

    function settleTable(){
        fetch(`/api/settlement_api/${table_number}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(), 
                        },
                    
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log(data) 
                        if (data.message ==='ç»“ç®—æˆåŠŸ'){
                            const subtotal = data.sum
                            alert(`ç»“ç®—æˆåŠŸ,å…±è®¡${data.sum}å…ƒ`)
                            location.reload()
                        }else if(data.message === 'æœ‰èœå“æœªå®Œæˆ'){
                            alert('æœ‰èœå“æœªå®Œæˆ')
                        }else{
                            alert('å·²ç»“ç®—ï¼Œé¡¾å®¢æœªç¦»å¼€')
                        }
                            
                        }
                    );
    }

    function backManage(){
        window.location.href = '/orderManage/';}

</script>
</body>
</html>



